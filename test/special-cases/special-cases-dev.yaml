apiVersion: testworkflows.testkube.io/v1
kind: TestWorkflow
metadata:
  name: special-cases-dev-credentials
  labels:
    core-tests: special-cases
    environment: dev
description: ".dev environment-only!"
spec:
  container:
    image: alpine:3.22.0
    env:
      - name: credential_plaintext_org_level
        value: '{{ credential("credential-plaintext-org-level") }}'
        global: true
      - name: credential_plaintext_env_level
        value: '{{ credential("credential-plaintext-env-level") }}'
        global: true
      - name: credential_plaintext_org_level_env_override
        value: '{{ credential("credential-plaintext-org-level-env-override") }}'
        global: true
      - name: credential_encrypted_org_level
        value: '{{ credential("credential-encrypted-org-level") }}'
        global: true
      - name: credential_encrypted_env_level
        value: '{{ credential("credential-encrypted-env-level") }}'
        global: true
      - name: credential_encrypted_org_level_env_override
        value: '{{ credential("credential-encrypted-org-level-env-override") }}'
        global: true
  services:
    echo-service:
      image: alpine:3.22.0
      shell: |
        echo "credential-plaintext-org-level ENV: $credential_plaintext_org_level"
        [ "$credential_plaintext_org_level" = "credential-plaintext-org-level-value" ] && [ '{{ credential("credential-plaintext-org-level") }}' = "credential-plaintext-org-level-value" ] && echo OK || (echo FAIL && exit 1)

        echo "credential-plaintext-env-level ENV: $credential_plaintext_env_level"
        [ "$credential_plaintext_env_level" = "credential-plaintext-env-level-value" ] && [ '{{ credential("credential-plaintext-env-level") }}' = "credential-plaintext-env-level-value" ] && echo OK || (echo FAIL && exit 1)

        echo "credential-plaintext-org-level-env-override ENV: $credential_plaintext_org_level_env_override"
        [ "$credential_plaintext_org_level_env_override" = "credential-plaintext-org-level-env-override-value2" ] && [ '{{ credential("credential-plaintext-org-level-env-override") }}' = "credential-plaintext-org-level-env-override-value2" ] && echo OK || (echo FAIL && exit 1)

        echo "credential-encrypted-org-level ENV: $credential_encrypted_org_level"
        [ "$credential_encrypted_org_level" = "credential-encrypted-org-level-value" ] && [ '{{ credential("credential-encrypted-org-level") }}' = "credential-encrypted-org-level-value" ] && echo OK || (echo FAIL && exit 1)

        echo "credential-encrypted-env-level ENV: $credential_encrypted_env_level"
        [ "$credential_encrypted_env_level" = "credential-encrypted-env-level-value" ] && [ '{{ credential("credential-encrypted-env-level") }}' = "credential-encrypted-env-level-value" ] && echo OK || (echo FAIL && exit 1)

        echo "credential-encrypted-org-level-env-override ENV: $credential_encrypted_org_level_env_override"
        [ "$credential_encrypted_org_level_env_override" = "credential-encrypted-org-level-env-override-value2" ] && [ '{{ credential("credential-encrypted-org-level-env-override") }}' = "credential-encrypted-org-level-env-override-value2" ] && echo OK || (echo FAIL && exit 1)
  steps:
    - name: Validate credentials
      run:
        shell: |
          echo "credential-plaintext-org-level ENV: $credential_plaintext_org_level"
          [ "$credential_plaintext_org_level" = "credential-plaintext-org-level-value" ] && [ '{{ credential("credential-plaintext-org-level") }}' = "credential-plaintext-org-level-value" ] && echo OK || (echo FAIL && exit 1)

          echo "credential-plaintext-env-level ENV: $credential_plaintext_env_level"
          [ "$credential_plaintext_env_level" = "credential-plaintext-env-level-value" ] && [ '{{ credential("credential-plaintext-env-level") }}' = "credential-plaintext-env-level-value" ] && echo OK || (echo FAIL && exit 1)

          echo "credential-plaintext-org-level-env-override ENV: $credential_plaintext_org_level_env_override"
          [ "$credential_plaintext_org_level_env_override" = "credential-plaintext-org-level-env-override-value2" ] && [ '{{ credential("credential-plaintext-org-level-env-override") }}' = "credential-plaintext-org-level-env-override-value2" ] && echo OK || (echo FAIL && exit 1)

          echo "credential-encrypted-org-level ENV: $credential_encrypted_org_level"
          [ "$credential_encrypted_org_level" = "credential-encrypted-org-level-value" ] && [ '{{ credential("credential-encrypted-org-level") }}' = "credential-encrypted-org-level-value" ] && echo OK || (echo FAIL && exit 1)

          echo "credential-encrypted-env-level ENV: $credential_encrypted_env_level"
          [ "$credential_encrypted_env_level" = "credential-encrypted-env-level-value" ] && [ '{{ credential("credential-encrypted-env-level") }}' = "credential-encrypted-env-level-value" ] && echo OK || (echo FAIL && exit 1)

          echo "credential-encrypted-org-level-env-override ENV: $credential_encrypted_org_level_env_override"
          [ "$credential_encrypted_org_level_env_override" = "credential-encrypted-org-level-env-override-value2" ] && [ '{{ credential("credential-encrypted-org-level-env-override") }}' = "credential-encrypted-org-level-env-override-value2" ] && echo OK || (echo FAIL && exit 1)
---
apiVersion: testworkflows.testkube.io/v1
kind: TestWorkflow
metadata:
  name: special-cases-dev-credentials-private-git-repository
  labels:
    core-tests: special-cases
    environment: dev
description: ".dev environment-only!"
spec:
  content:
    git:
      uri: https://github.com/kubeshop/testkube-external-tests
      revision: main
      username: '{{credential("git_testkube-external-tests_username")}}'
      token: '{{credential("git_testkube-external-tests_token")}}'
      paths:
      - testkube/k6-smoke-test.js
  container:
    image: grafana/k6:1.1.0
    resources:
      requests:
        cpu: 128m
        memory: 128Mi
    workingDir: /data/repo/testkube/k6
  job:
    activeDeadlineSeconds: 300
  steps:
  - name: Run test
    steps:
    - shell: mkdir /data/artifacts
    - run:
        shell: k6 run k6-smoke-test.js -e K6_ENV_FROM_PARAM=K6_ENV_FROM_PARAM_value --duration 30s
        env:
        - name: K6_SYSTEM_ENV
          value: K6_SYSTEM_ENV_value
        - name: K6_WEB_DASHBOARD
          value: "true"
        - name: K6_WEB_DASHBOARD_EXPORT
          value: "/data/artifacts/k6-test-report.html"
      steps:
      - name: Saving artifacts
        workingDir: /data/artifacts
        artifacts:
          paths:
          - '*'