name: Release MCP Server

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # Trigger on final release tags only (e.g., 1.19.0, not 1.19.0-rc.0 or 1.19.0-preview.0)
  # push:
  #   tags:
  #     - "[0-9]+.[0-9]+.[0-9]+"

  # Allow manual triggering for testing or re-publishing
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 1.19.0)'
        required: false
        default: '2.4.3'
        type: string

permissions:
  id-token: write  # Required for GitHub OIDC authentication with MCP Registry
  contents: read

env:
  DOCKER_IMAGE: kubeshop/mcp-server

jobs:
  build_and_push_mcp_image:
    name: Build and Push MCP Server Docker Image
    runs-on: depot-ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get version tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] || [ "${{ github.event_name }}" == "pull_request" ]; then
            # Manual trigger or PR testing - use input/default version
            VERSION="${{ inputs.version }}"
            if [ -z "$VERSION" ]; then
              VERSION="2.4.3"
            fi
            echo "tag=$VERSION" >> "$GITHUB_OUTPUT"
            echo "Using version: $VERSION"
          else
            # Tag push - extract version from tag
            TAG=${GITHUB_REF#refs/tags/}
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            echo "Using version from tag: $TAG"
          fi

      # - name: Build and push MCP Server image
      #   run: |
      #     VERSION=${{ steps.tag.outputs.tag }} \
      #     GIT_SHA=${{ github.sha }} \
      #     ./build/mcp-server/build-mcp-server.sh ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.tag }}

      # - name: Tag as latest
      #   run: |
      #     docker buildx imagetools create \
      #       --tag ${{ env.DOCKER_IMAGE }}:latest \
      #       ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.tag }}

      # - name: Verify image
      #   run: |
      #     echo "Verifying pushed images..."
      #     docker buildx imagetools inspect ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.tag }}
      #     docker buildx imagetools inspect ${{ env.DOCKER_IMAGE }}:latest

  publish_to_mcp_registry:
    name: Publish to MCP Registry
    needs: build_and_push_mcp_image
    runs-on: depot-ubuntu-22.04
    permissions:
      id-token: write  # Required for GitHub OIDC
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] || [ "${{ github.event_name }}" == "pull_request" ]; then
            # Manual trigger or PR testing - use input/default version
            VERSION="${{ inputs.version }}"
            if [ -z "$VERSION" ]; then
              VERSION="2.4.3"
            fi
            echo "tag=$VERSION" >> "$GITHUB_OUTPUT"
            echo "Using version: $VERSION"
          else
            # Tag push - extract version from tag
            TAG=${GITHUB_REF#refs/tags/}
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            echo "Using version from tag: $TAG"
          fi

      - name: Update server.json with version
        run: |
          cd build/mcp-server
          # Update both the top-level version and the Docker image identifier
          jq --arg version "${{ steps.tag.outputs.tag }}" \
            '.version = $version | .packages[0].identifier = "docker.io/kubeshop/mcp-server:" + $version' \
            server.json > server.json.tmp
          mv server.json.tmp server.json

          echo "Updated server.json:"
          cat server.json

      - name: Install mcp-publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_linux_amd64.tar.gz" | tar xz
          chmod +x mcp-publisher
          ./mcp-publisher --version

      - name: Authenticate via GitHub OIDC
        run: ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry
        run: |
          cd build/mcp-server
          ../../mcp-publisher publish

      - name: Verify publication
        run: |
          echo "Waiting for registry to update..."
          sleep 30

          echo "Verifying publication..."
          curl -f https://registry.modelcontextprotocol.io/v0/servers/io.github.kubeshop/testkube-mcp || \
            echo "Warning: Could not verify publication immediately. It may take a few minutes to appear."

      - name: Summary
        run: |
          echo "âœ… MCP Server published successfully!"
          echo ""
          echo "Docker Image: ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.tag }}"
          echo "Docker Image: ${{ env.DOCKER_IMAGE }}:latest"
          echo "MCP Registry: https://registry.modelcontextprotocol.io/v0/servers/io.github.kubeshop/testkube-mcp"
          echo ""
          echo "Users can now install with:"
          echo "  docker pull ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.tag }}"
          echo "  docker pull ${{ env.DOCKER_IMAGE }}:latest"
